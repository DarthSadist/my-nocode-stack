# Руководство по тестированию вебхуков n8n

## Обзор

Данный документ содержит инструкции по тестированию вебхуков n8n после исправления конфигурации, устраняющей проблему с портом в URL вебхуков.

## Важность правильной конфигурации URL вебхуков

В n8n вебхуки используются для приема входящих запросов, которые запускают рабочие процессы. Критически важно, чтобы URL вебхуков был сформирован корректно, без добавления лишних портов, иначе внешние системы не смогут правильно отправлять запросы.

## Исправление проблемы

В нашей конфигурации была выявлена проблема: n8n автоматически добавлял порт `5678` к URL вебхуков, что делало их недоступными при обращении через Caddy. Проблема решена добавлением переменной окружения:

```yaml
N8N_SKIP_WEBHOOK_PORT_PREFIX_FOR_MAIN_URL=true
```

## Шаги для тестирования вебхуков

### 1. Предварительная проверка конфигурации

Перед тестированием убедитесь, что конфигурация n8n содержит следующие параметры:

```yaml
N8N_HOST=n8n.${DOMAIN_NAME}
N8N_PROTOCOL=https
N8N_PORT=5678
N8N_WEBHOOK_URL=https://n8n.${DOMAIN_NAME}
N8N_WEBHOOK_TUNNEL_URL=https://n8n.${DOMAIN_NAME}
N8N_SKIP_WEBHOOK_PORT_PREFIX_FOR_MAIN_URL=true
```

### 2. Проверка доступности веб-интерфейса n8n

```bash
curl -I https://n8n.${DOMAIN_NAME}
```

Должен вернуться статус `200 OK`.

### 3. Создание тестового вебхука в n8n

1. Войдите в интерфейс n8n по адресу `https://n8n.${DOMAIN_NAME}`
2. Создайте новый рабочий процесс (workflow)
3. Добавьте узел "Webhook"
4. Настройте метод HTTP (например, POST)
5. Сохраните и активируйте рабочий процесс
6. Скопируйте сгенерированный URL вебхука

### 4. Проверка формата URL вебхука

Проверьте, что URL вебхука имеет формат:
```
https://n8n.${DOMAIN_NAME}/webhook/...
```

Убедитесь, что в URL **отсутствует порт** (например, `:5678`).

### 5. Тестирование вебхука с помощью curl

Выполните тестовый запрос к вебхуку:

```bash
curl -X POST -H "Content-Type: application/json" -d '{"test":"data"}' $WEBHOOK_URL
```

Где `$WEBHOOK_URL` - скопированный на шаге 3 URL вебхука.

### 6. Проверка журналов n8n

Проверьте журналы n8n, чтобы убедиться, что запрос был получен:

```bash
docker logs n8n | grep webhook
```

### 7. Тестирование через внешние сервисы

Для полной проверки, используйте внешний сервис (например, webhook.site) для отправки запросов к вашему вебхуку.

## Диагностика проблем

### Если вебхук все еще содержит порт в URL

1. Перезапустите контейнер n8n:
   ```bash
   docker restart n8n
   ```

2. Проверьте, что переменная `N8N_SKIP_WEBHOOK_PORT_PREFIX_FOR_MAIN_URL` установлена в значение `true`:
   ```bash
   docker exec n8n env | grep SKIP_WEBHOOK
   ```

3. Проверьте версию n8n. Данный функционал доступен начиная с версии 0.118.0.

### Если вебхук недоступен после всех проверок

1. Проверьте настройки Caddy:
   ```bash
   docker exec caddy cat /etc/caddy/Caddyfile
   ```

2. Убедитесь, что в Caddyfile корректно настроено проксирование для n8n:
   ```
   n8n.example.com {
       reverse_proxy n8n:5678
   }
   ```

3. Проверьте доступность сервиса n8n внутри контейнера Caddy:
   ```bash
   docker exec caddy curl -I http://n8n:5678
   ```

## Автоматизированные тесты

В директории `/home/den/my-nocode-stack/test-docs/` создан скрипт `test-n8n-webhooks.sh`, который автоматизирует процесс проверки вебхуков n8n.

Для запуска автоматических тестов выполните:

```bash
/home/den/my-nocode-stack/test-docs/test-n8n-webhooks.sh
```

## Выводы

Корректная настройка URL вебхуков n8n критически важна для правильного функционирования интеграций. Добавление параметра `N8N_SKIP_WEBHOOK_PORT_PREFIX_FOR_MAIN_URL=true` решает проблему с автоматическим добавлением порта к URL вебхуков, что обеспечивает их доступность при работе через Caddy.
