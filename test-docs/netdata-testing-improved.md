# Расширенное руководство по тестированию Netdata

## 4.9. Тестирование Netdata

Netdata - это мощная система мониторинга, предоставляющая подробную диагностику в реальном времени для вашей инфраструктуры. Корректное функционирование Netdata критически важно для обнаружения и устранения проблем до того, как они повлияют на работу сервисов.

### 4.9.1. Проверка доступности Netdata

```bash
# Проверка доступности веб-интерфейса Netdata по HTTP
curl -k -I https://netdata.yourdomain.com
```

**Что проверяем и почему это важно:**
- **Код ответа HTTP**: Должен быть 200 OK. Любой другой код (особенно 5xx) указывает на проблемы с сервисом.
- **Headers ответа**: Проверяем, что Content-Type соответствует HTML-странице (text/html).
- **Доступность через SSL**: Опция -k разрешает самоподписанные сертификаты, но в продакшн-среде стоит проверить корректность SSL-сертификата.

**Ожидаемый результат:**
```
HTTP/2 200 
server: Caddy
content-type: text/html
date: Fri, 09 May 2025 01:45:00 GMT
```

**Возможные проблемы и решения:**
- **503 Service Unavailable**: Контейнер Netdata может быть остановлен или перезагружается. Проверьте состояние контейнера с помощью `docker ps | grep netdata`.
- **Connection refused**: Порт может быть заблокирован файерволом. Проверьте настройки брандмауэра и правила пропуска трафика.
- **Gateway timeout**: Проблема с Caddy или сетевыми настройками. Проверьте конфигурацию прокси.

### 4.9.2. Анализ логов Netdata

```bash
# Проверка логов Netdata для обнаружения проблем
docker logs netdata
```

**Что проверяем и почему это важно:**
- **Ошибки запуска**: Ищем сообщения с префиксами "ERROR" или "CRITICAL", которые указывают на проблемы конфигурации.
- **Проблемы подключения**: Обращаем внимание на сообщения о неудачных попытках подключения к контейнерам для сбора метрик.
- **Утечки памяти**: Ищем сообщения о нехватке памяти или непредвиденных завершениях процессов.
- **Периодичность сбора метрик**: Проверяем, соответствует ли частота сбора метрик настройкам.

**Признаки здоровой работы Netdata в логах:**
- Сообщения инициализации без ошибок
- Подтверждение успешного подключения к контейнерам
- Стабильное обновление метрик с заданным интервалом
- Отсутствие повторяющихся ошибок/предупреждений

**Типичные проблемы и их решения:**
- **Ошибки доступа к данным контейнеров**: Убедитесь, что Netdata имеет доступ к сокету Docker: `docker exec netdata ls -la /var/run/docker.sock`
- **Нехватка памяти**: Увеличьте лимит памяти в docker-compose.yaml.template
- **Проблемы сбора метрик**: Проверьте, что все контейнеры находятся в одной сети с Netdata

### 4.9.3. Проверка API Netdata

```bash
# Проверка основных метрик через API
curl -s -k https://netdata.yourdomain.com/api/v1/info | jq
```

**Что проверяем и почему это важно:**
- **Версия Netdata**: Проверяем актуальность версии для безопасности и функциональности.
- **Uptime**: Анализируем, как долго работает сервис без перезапуска.
- **Количество собираемых метрик**: Большое число метрик подтверждает корректную настройку сборщиков данных.
- **Интервал обновления**: Значение должно соответствовать конфигурации (обычно 1-5 секунд).
- **Информация о хосте**: Проверяем правильность отображения имени хоста и ОС.

**Расширенная проверка метрик для ключевых сервисов:**

```bash
# Проверка метрик использования CPU по контейнерам 
curl -s -k "https://netdata.yourdomain.com/api/v1/data?chart=cgroup_n8n.cpu&format=json&points=60" | jq

# Проверка метрик использования памяти PostgreSQL
curl -s -k "https://netdata.yourdomain.com/api/v1/data?chart=cgroup_postgres.mem_usage&format=json&points=60" | jq

# Просмотр всех доступных графиков
curl -s -k "https://netdata.yourdomain.com/api/v1/charts" | jq
```

**Интерпретация результатов API:**
- Ответ должен быть валидным JSON без ошибок
- Данные должны обновляться (сравните две последовательные выборки)
- Значение полей status и status_message должно указывать на нормальную работу
- Количество метрик должно соответствовать количеству запущенных контейнеров

### 4.9.4. Функциональное тестирование Netdata

#### 4.9.4.1. Проверка отображения всех контейнеров

**Методика тестирования:**
1. Откройте веб-интерфейс Netdata: https://netdata.yourdomain.com
2. Перейдите в раздел "docker" или "cgroups" в левом меню
3. Проверьте наличие всех контейнеров из вашего стека:
   - n8n
   - postgres
   - flowise
   - qdrant
   - redis
   - wordpress
   - mariadb
   - waha

**Почему это важно:**
- Отсутствие контейнера в списке означает, что Netdata не получает его метрики, что создает слепую зону в мониторинге
- Мониторинг всех контейнеров позволяет быстро идентифицировать источник проблем при высокой нагрузке
- Сравнение метрик между контейнерами помогает выявить неоптимальное распределение ресурсов

**Особое внимание уделите:**
- Графикам потребления CPU и RAM каждым контейнером
- Метрикам ввода-вывода для контейнеров с базами данных
- Количеству и частоте запросов к сервисам

**Дополнительное тестирование через CLI:**
```bash
# Получение списка мониторящихся контейнеров через API
curl -s -k "https://netdata.yourdomain.com/api/v1/charts" | grep "cgroup_.*cpu" | cut -d. -f1 | sort | uniq | sed 's/cgroup_//'
```

#### 4.9.4.2. Тестирование системы уведомлений

**Подготовка:**
```bash
# Проверка настроенных уведомлений
docker exec netdata netdata-cli alerts info

# Настройка тестового алерта (если отсутствует)
cat > /tmp/test-alarm.conf << EOF
alarm: test_alarm
on: system.cpu
lookup: average -1m percentage foreach user,system
every: 1m
warn: $this > 0
crit: $this > 0
info: Тестовый алерт для проверки системы оповещений
to: sysadmin
EOF

docker cp /tmp/test-alarm.conf netdata:/etc/netdata/health.d/
docker exec netdata netdata-cli reload-health
```

**Тестирование оповещений:**
```bash
# Принудительное срабатывание тестового алерта
docker exec netdata netdata-cli test-alert test_alarm
```

**Что проверять:**
- **Email-уведомления**: Проверьте получение письма на настроенный адрес
- **Slack/Discord**: Подтвердите доставку сообщения в настроенный канал
- **Telegram**: Проверьте получение уведомления в Telegram-бот
- **Формат уведомлений**: Убедитесь, что сообщение содержит полезную информацию о проблеме

**Важные аспекты настройки уведомлений:**
- Используйте разные каналы для разных уровней критичности
- Настройте фильтрацию неважных уведомлений для предотвращения "шума оповещений"
- Проверьте задержку доставки оповещений (должна быть минимальной)

#### 4.9.4.3. Проверка настроек алармов (тревог)

**Методика тестирования:**
```bash
# Получение списка всех настроенных тревог
docker exec netdata netdata-cli alerts list

# Проверка настроек конкретной тревоги
docker exec netdata netdata-cli alerts show ram_available

# Просмотр текущего состояния тревог
docker exec netdata netdata-cli alerts active
```

**Ключевые аларм-правила для проверки:**
- **system.ram**: Свободная оперативная память
- **system.cpu**: Нагрузка на процессор
- **disk_space._.available**: Доступное место на диске
- **cgroup_NAME.cpu**: Нагрузка CPU конкретного контейнера (особенно для баз данных)
- **cgroup_NAME.mem**: Использование памяти контейнером
- **postgres.connections**: Число подключений к PostgreSQL

**Проверка настроек порогов срабатывания:**
- Пороги должны быть разумными для вашей инфраструктуры
- Избегайте слишком чувствительных настроек (постоянные ложные срабатывания)
- Убедитесь, что критические сервисы имеют более жесткие пороги

**Дополнительные настройки:**
```bash
# Настройка рекомендуемых порогов для баз данных
cat > /tmp/postgres-alarms.conf << EOF
alarm: postgres_connections
on: postgres.connections
lookup: average -10m unaligned of used
every: 1m
warn: $this > 80
crit: $this > 90
info: Количество соединений к PostgreSQL превышает рекомендуемые пределы
to: dba
EOF

docker cp /tmp/postgres-alarms.conf netdata:/etc/netdata/health.d/
docker exec netdata netdata-cli reload-health
```

#### 4.9.4.4. Тестирование экспорта данных

Netdata позволяет экспортировать метрики во внешние системы для долгосрочного хранения и анализа.

**Проверка настроек экспорта:**
```bash
# Просмотр конфигурации экспортера
docker exec netdata cat /etc/netdata/exporting.conf

# Проверка логов экспорта
docker exec netdata grep 'exporting' /var/log/netdata/error.log
```

**Тестирование экспорта в Prometheus:**
```bash
# Проверка доступности точки экспорта Prometheus 
curl -s -k https://netdata.yourdomain.com/api/v1/allmetrics?format=prometheus | head

# Проверка подключения Prometheus (если настроен)
curl -s http://prometheus:9090/api/v1/targets | jq .
```

**Тестирование экспорта в другие системы:**
- **InfluxDB**: Проверьте наличие метрик в базе данных InfluxDB
- **Graphite**: Проверьте получение метрик сервером Graphite
- **Elasticsearch**: Поиск метрик Netdata в индексах Elasticsearch

**Важные аспекты экспорта данных:**
- Убедитесь, что ключевые метрики экспортируются без потерь
- Проверьте периодичность отправки данных (обычно раз в 10-60 секунд)
- Для сценариев долгосрочного хранения убедитесь в корректной агрегации данных

### 4.9.5. Расширенное тестирование Netdata

#### 4.9.5.1. Проверка пользовательских метрик

Если вы настроили пользовательские метрики для ваших приложений, важно проверить их корректность:

```bash
# Проверка пользовательских метрик через API
curl -s -k "https://netdata.yourdomain.com/api/v1/charts" | grep "custom_" | jq

# Тестирование отправки пользовательских метрик
echo "custom_metric.value 123" | nc -u -w1 127.0.0.1 8125
```

#### 4.9.5.2. Проверка интеграции с системой журналирования

```bash
# Проверка сбора логов через journald
docker exec netdata grep 'systemd-journal' /var/log/netdata/error.log

# Просмотр метрик на основе логов
curl -s -k "https://netdata.yourdomain.com/api/v1/data?chart=logs.log_verification" | jq
```

#### 4.9.5.3. Тестирование производительности Netdata

```bash
# Проверка нагрузки от самого Netdata
docker stats netdata

# Проверка использования диска для хранения метрик
docker exec netdata du -sh /var/cache/netdata
```

**Обратите внимание на:**
- Netdata должен потреблять разумное количество ресурсов (обычно <5% CPU, <300MB RAM)
- Объем данных на диске должен быть контролируемым
- Периодичность обновления веб-интерфейса должна соответствовать настройкам
