# Расширенное руководство по тестированию базовой инфраструктуры

## 3. Тестирование базовой инфраструктуры

Тестирование базовой инфраструктуры является фундаментальным этапом, который позволяет убедиться в правильности настройки контейнеров, сетей и томов Docker. Корректная работа базовой инфраструктуры критически важна для функционирования всего стека.

### 3.1. Проверка запущенных контейнеров

```bash
# Список всех контейнеров
docker ps --all
```

**Что проверяем и почему это важно:**
- **Статус контейнеров**: Все контейнеры должны быть в состоянии "Up" (запущены)
- **Время работы**: Позволяет выявить контейнеры, которые часто перезапускаются (симптом нестабильности)
- **Порты**: Проверяем, что все нужные порты правильно проброшены на хост
- **Имена контейнеров**: Убедитесь, что имена соответствуют ожидаемым и нет дубликатов

**Признаки проблем в выводе команды:**
- Контейнеры со статусом "Restarting" – указывает на нестабильную работу
- Контейнеры со статусом "Created" или "Exited" – не запущены должным образом
- Частые перезапуски (малое время Up) – признак проблем в приложении или конфигурации

**Дополнительные проверки контейнеров:**
```bash
# Детальная информация о контейнере (на примере n8n)
docker inspect n8n

# Проверка использования ресурсов контейнерами
docker stats --no-stream

# Проверка контейнеров с ошибками
docker ps -a -f status=exited
```

```bash
# Проверка состояния всех сервисов
docker-compose -f /home/den/my-nocode-stack/docker-compose.yaml ps
```

**Что проверяем:**
- **Согласованность сервисов**: Все сервисы, описанные в docker-compose.yaml, должны быть запущены
- **Состояние сервисов**: Должно быть "Up" для всех сервисов
- **Порты**: Проверяем корректность проброса портов согласно конфигурации

**Признаки здоровой системы:**
- Все сервисы в состоянии "Up"
- Нет сообщений о ошибках или предупреждениях
- Порты указаны согласно конфигурации

**Действия при обнаружении проблем:**
- Проверить логи проблемного контейнера: `docker logs <имя_контейнера>`
- Перезапустить проблемный сервис: `docker-compose restart <имя_сервиса>`
- Проверить конфигурацию в docker-compose.yaml

```bash
# Проверка сетей Docker
docker network ls
```

**Что проверяем:**
- Наличие сети **app-network**, которая используется для связи между контейнерами
- Наличие стандартной сети **bridge** для внешних подключений
- Соответствие драйверов сетей (обычно bridge для локального развертывания)

```bash
# Детальная проверка сети app-network
docker network inspect app-network
```

**Важные аспекты при проверке сети:**
- **Список подключенных контейнеров**: Все контейнеры из вашего стека должны быть в списке
- **Конфигурация IP**: Проверка выделенных IP-адресов и отсутствия конфликтов
- **Сетевые драйверы**: Убедитесь, что используется правильный драйвер (обычно bridge)
- **Подсети**: Проверьте, что настроенные подсети не конфликтуют с другими сетями

**Тестирование связи между контейнерами:**
```bash
# Проверка связи между n8n и postgres
docker exec n8n ping -c 3 postgres

# Проверка связи между flowise и qdrant
docker exec flowise ping -c 3 qdrant

# Проверка доступа к базе данных из n8n
docker exec n8n curl -s postgres:5432
```

**Ожидаемые результаты:**
- При выполнении ping между контейнерами должны быть успешные ответы без потери пакетов
- Время ответа (ping) должно быть минимальным (обычно <1ms в рамках одной сети Docker)
- При проверке доступа к портам сервисов должно быть подтверждение доступности

### 3.2. Проверка работы Caddy (обратный прокси)

Caddy выполняет критически важную роль: обеспечивает безопасный доступ к сервисам через HTTPS и управляет маршрутизацией запросов.

```bash
# Проверка конфигурации Caddy
docker exec caddy caddy validate --config /etc/caddy/Caddyfile
```

**Что проверяем:**
- **Валидность конфигурации**: Отсутствие синтаксических ошибок в Caddyfile
- **Загруженные модули**: Проверка наличия всех необходимых модулей Caddy
- **Настройки TLS**: Проверка корректности настроек SSL/TLS

**Признаки корректной настройки:**
- Сообщение о успешной валидации конфигурации
- Отсутствие предупреждений и ошибок
- Подтверждение загрузки всех необходимых модулей

```bash
# Проверка сертификатов SSL
docker exec caddy ls -la /data/caddy/certificates
```

**Что проверяем:**
- **Наличие сертификатов**: Для каждого настроенного домена должен быть сертификат
- **Актуальность сертификатов**: Проверка даты выдачи и срока действия
- **Права доступа**: Сертификаты должны иметь правильные разрешения для безопасного использования

**Детальная проверка сертификатов:**
```bash
# Проверка информации о сертификате для одного из доменов
docker exec caddy openssl x509 -in /data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/yourdomain.com/yourdomain.com.crt -text -noout | grep -E "Subject:|Issuer:|Not Before:|Not After :|DNS:"
```

**Важные параметры сертификата:**
- Срок действия: не менее 30 дней до истечения
- Issuer: должен соответствовать Let's Encrypt или другому настроенному центру сертификации
- Subject: должен содержать корректный домен
- DNS имена: должны включать все поддомены, настроенные в Caddyfile

```bash
# Тестирование доступности сервисов через Caddy
for service in n8n flowise wordpress waha qdrant; do
  curl -k -I https://$service.yourdomain.com
done
```

**Что проверяем в ответах HTTP:**
- **Код ответа**: 200 OK для работающих служб
- **Заголовок сервера**: Должен указывать Caddy
- **Content-Type**: Соответствует типу контента (text/html для веб-интерфейсов)
- **Безопасность**: Наличие соответствующих заголовков безопасности

**Расширенное тестирование Caddy:**
```bash
# Проверка автоматического перенаправления HTTP на HTTPS
curl -I -L http://n8n.yourdomain.com

# Проверка версии Caddy
docker exec caddy caddy version

# Проверка доступности метрик Caddy (если настроено)
curl -k https://yourdomain.com/metrics
```

**Проверка правил перенаправления:**
```bash
# Тестирование редиректов в Caddy
for path in /old-path /legacy /test; do
  echo "Testing redirect from $path:"
  curl -k -I -L https://yourdomain.com$path
  echo "-----------------------"
done
```

### 3.3. Проверка доступа к Docker томам

Docker тома - это ключевой механизм хранения персистентных данных в контейнерах. Корректная настройка томов критически важна для сохранения данных при перезапусках.

```bash
# Список всех томов
docker volume ls
```

**Что проверяем:**
- **Наличие всех необходимых томов**: n8n_data, n8n_postgres_data, wordpress_data и т.д.
- **Драйвер хранения**: обычно local для стандартного развертывания
- **Именование томов**: соответствие ожидаемой схеме именования

**Важность правильной настройки томов:**
- Тома обеспечивают сохранение данных между перезапусками контейнеров
- Потеря или повреждение тома может привести к потере всех данных соответствующего сервиса
- Корректный доступ к томам критичен для функционирования служб и резервного копирования

```bash
# Проверка прав доступа к основным томам
for volume in n8n_data n8n_postgres_data qdrant_storage flowise_data wordpress_data wordpress_db_data redis_data; do
  docker volume inspect $volume
done
```

**Что проверять в выводе команды:**
- **Mountpoint**: Физическое расположение данных тома на хост-системе
- **Driver**: Должен соответствовать настройкам (обычно local)
- **Labels**: Должны соответствовать проекту и назначению тома

**Дополнительные проверки томов:**
```bash
# Проверка размера данных в томе (требует sudo)
sudo du -sh $(docker volume inspect n8n_data --format '{{ .Mountpoint }}')

# Проверка прав доступа к физическим данным тома
sudo ls -la $(docker volume inspect n8n_postgres_data --format '{{ .Mountpoint }}')

# Проверка занятого места по всем томам
for volume in $(docker volume ls --format '{{.Name}}'); do
  echo "Volume: $volume"
  sudo du -sh $(docker volume inspect $volume --format '{{ .Mountpoint }}')
done
```

**Тестирование персистентности томов:**
```bash
# Создание тестового файла в томе WordPress
docker exec wordpress touch /var/www/html/volume-test-file.txt

# Перезапуск контейнера
docker restart wordpress

# Проверка, что файл сохранился после перезапуска
docker exec wordpress ls -la /var/www/html/volume-test-file.txt

# Удаление тестового файла
docker exec wordpress rm /var/www/html/volume-test-file.txt
```

**Важные аспекты тестирования томов:**
- Данные должны сохраняться между перезапусками контейнеров
- Права доступа должны позволять сервисам читать и записывать данные
- Физическое размещение томов должно быть на разделе с достаточным свободным местом

### 3.4. Проверка логов системы

Логи - это ключевой инструмент для отладки и мониторинга системы. Проверка логов позволяет выявить скрытые проблемы, которые не видны при обычной работе.

```bash
# Проверка логов Docker
sudo journalctl -u docker -n 100
```

**Что искать в логах Docker:**
- **Ошибки запуска контейнеров**: Сообщения об ошибках при создании или запуске
- **Проблемы с сетью**: Ошибки при настройке сетевых интерфейсов
- **Проблемы с дисковым пространством**: Предупреждения о недостатке места
- **Сообщения о лимитах ресурсов**: Превышение ограничений CPU, RAM или IO

**Признаки проблем в логах:**
- Повторяющиеся ошибки или предупреждения
- Сообщения о нехватке ресурсов
- Ошибки при монтировании томов
- Частые перезапуски контейнеров

```bash
# Проверка логов Caddy
docker logs caddy
```

**Что искать в логах Caddy:**
- **Успешная инициализация**: Сообщения о запуске и готовности сервера
- **Процесс получения сертификатов**: Успешное получение SSL-сертификатов для всех доменов
- **Обработка запросов**: Логи запросов с кодами ответов (200, 301, 404, 500 и т.д.)
- **Ошибки конфигурации**: Предупреждения или ошибки при загрузке настроек

**Примеры важных сообщений в логах Caddy:**
- "obtained certificate..." - успешное получение сертификата
- "server listening..." - успешный запуск сервера
- "handled request..." - обработка HTTP-запросов
- "[ERROR]" или "[WARN]" - указывают на проблемы, требующие внимания

```bash
# Проверка системных логов
sudo tail -n 100 /var/log/syslog
```

**Что искать в системных логах:**
- **Ошибки ядра**: Проблемы на уровне операционной системы
- **Проблемы с дисковой подсистемой**: Ошибки ввода-вывода, проблемы с файловой системой
- **Сетевые проблемы**: Ошибки сетевых интерфейсов или маршрутизации
- **OOM (Out of Memory)**: Сообщения о принудительном завершении процессов из-за нехватки памяти

**Дополнительные проверки логов:**
```bash
# Проверка логов всех контейнеров
for container in $(docker ps --format "{{.Names}}"); do
  echo "=== Logs for $container ==="
  docker logs --tail 20 $container
  echo "======================="
done

# Поиск ошибок в логах контейнеров
for container in $(docker ps --format "{{.Names}}"); do
  echo "=== Errors in $container logs ==="
  docker logs $container 2>&1 | grep -i "error\|warn\|exception\|fail" | tail -20
  echo "======================="
done
```

**Анализ журналов аудита (если включен):**
```bash
# Проверка журналов аудита Docker
sudo ausearch -m avc --start today | grep docker

# Проверка журналов безопасности
sudo cat /var/log/auth.log | grep -i "fail\|error\|denied"
```

### 3.5. Проверка маршрутизации и сетевых правил

Корректная настройка маршрутизации и сетевых правил критична для безопасной и надежной работы стека.

```bash
# Проверка сетевых правил iptables
sudo iptables -L -n -v
```

**Что проверяем:**
- **Правила для портов 80 и 443**: Должны быть открыты для работы Caddy
- **Правила для Docker**: Наличие правил для сетей Docker (обычно с префиксом DOCKER)
- **Правила безопасности**: Блокирование нежелательного трафика

```bash
# Проверка маршрутизации
ip route show
```

**Важные аспекты маршрутизации:**
- Маршруты для сетей Docker (обычно 172.17.0.0/16, 172.18.0.0/16 и т.д.)
- Корректный маршрут по умолчанию (default gateway)
- Отсутствие дублирующихся или конфликтующих маршрутов

**Тестирование внешней доступности:**
```bash
# Проверка доступности извне (запустить с внешнего компьютера)
curl -I https://yourdomain.com
curl -I https://n8n.yourdomain.com
curl -I https://wordpress.yourdomain.com
```

**Проверка ограничений доступа:**
```bash
# Тестирование доступа к защищенным ресурсам
curl -I https://n8n.yourdomain.com/rest/admin
curl -I https://qdrant.yourdomain.com/collections
```

**Ожидаемые результаты:**
- Защищенные ресурсы должны требовать аутентификацию (HTTP 401 или 403)
- Публичные ресурсы должны быть доступны (HTTP 200)
- Редиректы должны работать корректно (HTTP 301/302 с правильным Location)

### 3.6. Проверка DNS-настроек

Корректная работа DNS необходима для правильной маршрутизации запросов к различным сервисам.

```bash
# Проверка DNS-резолвинга для основных доменов
for domain in yourdomain.com n8n.yourdomain.com flowise.yourdomain.com wordpress.yourdomain.com qdrant.yourdomain.com; do
  echo "Checking $domain:"
  dig $domain +short
  echo "---------------------"
done
```

**Что проверяем:**
- **IP-адреса**: Должны соответствовать ожидаемому IP-адресу сервера
- **CNAME-записи**: Для поддоменов, если используется CNAME вместо A-записей
- **Консистентность**: Все поддомены должны указывать на один и тот же IP или правильный CNAME

**Дополнительные DNS-проверки:**
```bash
# Проверка MX-записей (для email)
dig MX yourdomain.com +short

# Проверка TXT-записей (для верификации домена)
dig TXT yourdomain.com +short

# Проверка CAA-записей (для SSL-сертификатов)
dig CAA yourdomain.com +short
```

**Тестирование локального DNS-резолвинга:**
```bash
# Проверка локального резолвинга внутри контейнеров
for container in n8n flowise wordpress; do
  echo "DNS check from $container:"
  docker exec $container nslookup postgres
  docker exec $container nslookup qdrant
  echo "---------------------"
done
```

**Важные аспекты DNS-настройки:**
- Соответствие IP-адресов фактическому серверу
- Корректная настройка всех поддоменов
- Правильное время кеширования (TTL) для быстрого применения изменений
- Работающий DNS-резолвинг как внешний, так и внутренний (между контейнерами)
