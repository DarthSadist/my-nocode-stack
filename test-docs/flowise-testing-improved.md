# Расширенное руководство по тестированию Flowise

## 4.3. Тестирование Flowise

Flowise - это мощная платформа для создания и развертывания решений на базе искусственного интеллекта с графическим интерфейсом. Как ключевой компонент стека, отвечающий за AI-возможности, Flowise требует тщательного тестирования для обеспечения его надежной работы и корректной интеграции с другими сервисами.

### 4.3.1. Проверка доступности Flowise

```bash
# Проверка доступности по HTTP
curl -k -I https://flowise.yourdomain.com
```

**Что проверяем и почему это важно:**
- **Код ответа HTTP**: Должен быть 200 OK. Другие коды, особенно 5xx, указывают на проблемы с сервисом.
- **Заголовки ответа**: Проверяем наличие правильных заголовков безопасности и типа контента.
- **Время отклика**: Быстрый отклик указывает на отсутствие проблем с производительностью.

**Ожидаемый результат:**
```
HTTP/2 200 
server: Caddy
content-type: text/html; charset=utf-8
date: Fri, 09 May 2025 02:15:00 GMT
strict-transport-security: max-age=31536000; includeSubDomains
```

**Возможные проблемы и их решения:**
- **503 Service Unavailable**: Контейнер может быть не запущен. Проверьте `docker ps | grep flowise`.
- **504 Gateway Timeout**: Сервис запускается, но не отвечает. Проверьте логи: `docker logs flowise`.
- **Connection refused**: Проблемы с сетевыми настройками или Caddy. Проверьте конфигурацию прокси.

**Дополнительная проверка через браузер:**
1. Откройте https://flowise.yourdomain.com в браузере
2. Убедитесь, что интерфейс загружается корректно
3. Проверьте наличие всех компонентов UI (навигация, компоненты, рабочая область)
4. Проверьте отсутствие ошибок в консоли (F12 -> Console)

### 4.3.2. Проверка логов Flowise

```bash
# Проверка логов Flowise
docker logs flowise
```

**Что искать в логах:**
- **Успешный запуск**: Сообщения об инициализации сервера и компонентов.
- **Ошибки и предупреждения**: Обратите внимание на записи с уровнями ERROR или WARN.
- **Загрузка компонентов**: Убедитесь, что все требуемые компоненты (ноды) загружены.
- **Соединения с внешними сервисами**: Проверьте успешные подключения к API, базам данных и т.д.

**Признаки здоровой работы в логах:**
- "Server running at port" - подтверждение успешного запуска сервера
- "Loaded components" - успешная загрузка компонентов
- Отсутствие повторяющихся ошибок
- Стабильное время ответа на запросы

**Полезные команды для анализа логов:**
```bash
# Поиск ошибок в логах
docker logs flowise 2>&1 | grep -i "error\|exception\|fail"

# Проверка последних записей
docker logs --tail 50 flowise

# Мониторинг логов в реальном времени
docker logs -f flowise
```

### 4.3.3. Тестирование API Flowise

```bash
# Проверка API Flowise
curl -k -X GET https://flowise.yourdomain.com/api/v1/health
```

**Что проверяем:**
- **Статус API**: Должен возвращать {"status":"OK"} или подобный ответ, указывающий на работоспособность.
- **Время отклика**: Быстрый отклик свидетельствует о хорошей производительности.
- **Доступность API**: Подтверждение, что API-интерфейс доступен для интеграций.

**Дополнительные проверки API:**
```bash
# Получение списка чатфлоу (потоков)
curl -k -X GET https://flowise.yourdomain.com/api/v1/chatflows

# Получение доступных компонентов
curl -k -X GET https://flowise.yourdomain.com/api/v1/components

# Проверка версии API
curl -k -X GET https://flowise.yourdomain.com/api/v1/version
```

**Что проверять в ответах:**
- Корректный JSON-формат
- Отсутствие ошибок
- Полнота данных (все ожидаемые поля присутствуют)
- Соответствие структуре API Flowise

### 4.3.4. Функциональное тестирование Flowise

#### 4.3.4.1. Вход в систему

**Тестирование через UI:**
1. Откройте https://flowise.yourdomain.com в браузере
2. Если настроена аутентификация, введите учетные данные
3. Проверьте успешный вход и доступ к интерфейсу

**Тестирование через API (если настроена аутентификация):**
```bash
# Получение токена аутентификации
curl -k -X POST https://flowise.yourdomain.com/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# Использование токена для доступа к защищенным эндпоинтам
curl -k -X GET https://flowise.yourdomain.com/api/v1/chatflows \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

**Проверяемые аспекты:**
- Корректная аутентификация с правильными учетными данными
- Отказ в доступе при неверных учетных данных
- Генерация и использование JWT-токенов
- Таймаут сессии и обновление токенов

#### 4.3.4.2. Создание тестового AI-потока

**Шаги для создания тестового потока через UI:**
1. Нажмите "Create New" для создания нового чатфлоу
2. Добавьте узел Chat (например, OpenAI, местная модель или Ollama)
3. Добавьте узел Text Input
4. Добавьте узел Output Parser (если необходимо)
5. Соедините узлы (Text Input -> Chat -> Output Parser)
6. Настройте параметры каждого узла
7. Сохраните поток с именем "Test Flow"

**Скрипт для программного создания потока через API:**
```bash
# Создание тестового потока через API
curl -k -X POST https://flowise.yourdomain.com/api/v1/chatflows \
  -H "Content-Type: application/json" \
  -d '{
    "name": "API Test Flow",
    "description": "Flow created via API",
    "nodes": [
      {
        "id": "node1",
        "type": "textInput",
        "data": {
          "name": "User Input",
          "inputType": "text"
        },
        "position": {
          "x": 200,
          "y": 300
        }
      },
      {
        "id": "node2",
        "type": "chatOpenAI",
        "data": {
          "name": "AI Response",
          "temperature": 0.7,
          "modelName": "gpt-3.5-turbo",
          "systemMessage": "You are a helpful assistant."
        },
        "position": {
          "x": 600,
          "y": 300
        }
      }
    ],
    "edges": [
      {
        "source": "node1",
        "target": "node2"
      }
    ]
  }'
```

**Что проверять:**
- Успешное создание и сохранение потока
- Соединения между узлами сохраняются корректно
- Настройки узлов применяются правильно
- Поток становится доступным для выполнения и редактирования

#### 4.3.4.3. Тестирование выполнения AI-потока

```bash
# Получение ID сохраненного потока
FLOW_ID=$(curl -k -s https://flowise.yourdomain.com/api/v1/chatflows | jq -r '.[0].id')

# Тестирование запроса к API потока
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Что такое искусственный интеллект?",
    "overrideConfig": {
      "sessionId": "test-session-123"
    }
  }'
```

**Что проверять:**
- **Успешный ответ**: AI должен вернуть содержательный ответ на вопрос.
- **Время отклика**: Проверьте время выполнения запроса (должно быть разумным для выбранной модели).
- **Обработка сессий**: При повторных запросах сессия должна сохраняться (если настроено).
- **Обработка ошибок**: Если отправить некорректный запрос, должна вернуться понятная ошибка.

**Тестирование потока через интерфейс:**
1. Откройте интерфейс Flowise
2. Перейдите к сохраненному потоку
3. Нажмите "Chat" для открытия интерфейса чата
4. Отправьте различные типы запросов для тестирования
5. Проверьте ответы и взаимодействие с пользователем

#### 4.3.4.4. Тестирование подключения к внешним моделям

**Проверка подключения к OpenAI:**
```bash
# Создание тестового запроса к API OpenAI через Flowise
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Проверка подключения к API OpenAI",
    "overrideConfig": {
      "apiKey": "${OPENAI_API_KEY}"
    }
  }'
```

**Проверка подключения к локальным моделям (например, через Ollama):**
```bash
# Проверка доступности Ollama (если используется)
docker exec flowise curl -s http://ollama:11434/api/health

# Тест запроса к локальной модели
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${LOCAL_FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Проверка подключения к локальной модели"
  }'
```

**Что проверять:**
- Корректное соединение с внешними API
- Обработка ключей API и аутентификации
- Правильная передача параметров моделям
- Обработка ограничений и ошибок API

### 4.3.5. Тестирование кастомных компонентов (если используются)

```bash
# Проверка наличия кастомных компонентов
docker exec flowise ls -la /root/.flowise/custom

# Получение списка доступных компонентов через API
curl -k -X GET https://flowise.yourdomain.com/api/v1/components
```

**Что проверять:**
- Успешная загрузка кастомных компонентов
- Доступность компонентов в интерфейсе
- Корректное выполнение функций кастомных компонентов
- Отсутствие конфликтов с встроенными компонентами

**Тестирование кастомного компонента в потоке:**
1. Создайте новый поток с использованием кастомного компонента
2. Настройте все необходимые параметры
3. Запустите поток и проверьте результаты
4. Убедитесь, что компонент выполняет свою функцию корректно

### 4.3.6. Тестирование интеграции с векторными хранилищами

#### 4.3.6.1. Интеграция с Qdrant

```bash
# Создание тестового потока с использованием Qdrant
# (Через UI или API)

# Тестирование запроса с векторным поиском
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${VECTOR_FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Найди информацию по теме искусственного интеллекта",
    "overrideConfig": {
      "sessionId": "vector-test-123"
    }
  }'
```

**Что проверять:**
- Корректное создание и использование коллекций в Qdrant
- Правильная векторизация запросов
- Точность результатов семантического поиска
- Эффективность использования памяти при работе с большими наборами данных

#### 4.3.6.2. Интеграция с pgvector (если используется)

```bash
# Тестирование интеграции с pgvector в PostgreSQL
# (Через UI или API создайте поток, использующий PostgreSQL с pgvector)
```

**Что проверять:**
- Корректное соединение с базой данных PostgreSQL
- Создание и использование векторных полей
- Выполнение векторного поиска через SQL
- Соответствие результатов ожиданиям

### 4.3.7. Тестирование производительности Flowise

#### 4.3.7.1. Проверка потребления ресурсов

```bash
# Мониторинг использования ресурсов контейнером
docker stats flowise --no-stream

# Проверка использования CPU и памяти при бездействии
docker stats flowise --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}"
```

**Что проверять:**
- Использование CPU в состоянии покоя (обычно <5%)
- Потребление памяти в состоянии покоя (обычно 100-300 MB)
- Отсутствие утечек ресурсов при длительной работе

#### 4.3.7.2. Тестирование под нагрузкой

```bash
# Скрипт для нагрузочного тестирования
cat > /tmp/flowise-load-test.sh << EOF
#!/bin/bash
FLOW_ID="\$1"  # ID потока передается как параметр
NUM_REQUESTS=10
CONCURRENT=5

echo "Sending \$NUM_REQUESTS requests to Flowise flow \$FLOW_ID with \$CONCURRENT concurrent requests"

for i in \$(seq 1 \$CONCURRENT); do
  (
    for j in \$(seq 1 \$((NUM_REQUESTS/CONCURRENT))); do
      request_id="\$i-\$j"
      echo "Sending request \$request_id"
      curl -k -s -X POST "https://flowise.yourdomain.com/api/v1/prediction/\$FLOW_ID" \
        -H "Content-Type: application/json" \
        -d "{
          \"question\": \"Тестовый запрос \$request_id. Расскажи о технологиях искусственного интеллекта.\",
          \"overrideConfig\": {
            \"sessionId\": \"load-test-\$request_id\"
          }
        }" > /dev/null
      echo "Request \$request_id completed"
      sleep 1
    done
  ) &
done

wait
echo "Load test completed"
EOF

chmod +x /tmp/flowise-load-test.sh

# Запуск нагрузочного тестирования
FLOW_ID=$(curl -k -s https://flowise.yourdomain.com/api/v1/chatflows | jq -r '.[0].id')
/tmp/flowise-load-test.sh $FLOW_ID
```

**Что проверять во время нагрузочного тестирования:**
- Стабильность работы при параллельных запросах
- Использование ресурсов (CPU, память) под нагрузкой
- Время отклика при увеличении нагрузки
- Корректность всех ответов даже при высокой нагрузке

**Мониторинг ресурсов во время тестирования:**
```bash
# Запуск в отдельном терминале во время нагрузочного тестирования
docker stats flowise
```

### 4.3.8. Тестирование стабильности и восстановления

#### 4.3.8.1. Проверка поведения при перезапуске

```bash
# Создание тестового потока для проверки персистентности
# (Через UI или API)

# Перезапуск контейнера
docker restart flowise

# Проверка наличия созданного потока после перезапуска
curl -k -X GET https://flowise.yourdomain.com/api/v1/chatflows | jq .
```

**Что проверять:**
- Сохранение всех созданных потоков после перезапуска
- Сохранение настроек компонентов и соединений
- Корректная загрузка всех зависимостей при запуске
- Восстановление всех соединений с внешними сервисами

#### 4.3.8.2. Проверка восстановления после сбоя

```bash
# Имитация сбоя (грубый останов)
docker kill --signal=SIGKILL flowise

# Проверка автоматического перезапуска
sleep 10
docker ps | grep flowise

# Проверка работоспособности после перезапуска
curl -k -I https://flowise.yourdomain.com

# Проверка доступности API
curl -k -X GET https://flowise.yourdomain.com/api/v1/health
```

**Что проверять:**
- Автоматический перезапуск контейнера после сбоя
- Сохранение всех данных и настроек
- Корректное восстановление функциональности
- Правильная обработка сессий после восстановления

### 4.3.9. Тестирование интеграции с другими компонентами стека

#### 4.3.9.1. Интеграция Flowise с n8n

**Создание API-эндпоинта в Flowise для использования из n8n:**
1. Создайте поток в Flowise с API-интерфейсом
2. Опубликуйте поток для доступа через API
3. Запомните ID потока для использования в n8n

**Создание workflow в n8n для взаимодействия с Flowise:**
1. Создайте новый workflow в n8n
2. Добавьте узел HTTP Request
3. Настройте запрос к API Flowise (используя ID потока)
4. Запустите workflow и проверьте результаты

```bash
# Тестирование вызова Flowise API из командной строки (как это сделал бы n8n)
FLOW_ID=$(curl -k -s https://flowise.yourdomain.com/api/v1/chatflows | jq -r '.[0].id')
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Этот запрос имитирует вызов из n8n. Как интегрировать AI в рабочие процессы?",
    "overrideConfig": {
      "sessionId": "n8n-integration-test"
    }
  }'
```

**Что проверять:**
- Корректная обработка запросов из n8n
- Правильная передача параметров и возврат результатов
- Стабильность работы при многократных вызовах
- Обработка ошибок и особых случаев

#### 4.3.9.2. Интеграция Flowise с Qdrant

```bash
# Проверка доступности Qdrant из контейнера Flowise
docker exec flowise curl -s http://qdrant:6333/health

# Создание тестовой коллекции в Qdrant для использования в Flowise
curl -X PUT "http://localhost:6333/collections/flowise_test" \
  -H "Content-Type: application/json" \
  -d '{
    "vectors": {
      "size": 384,
      "distance": "Cosine"
    }
  }'

# Создание потока в Flowise, использующего Qdrant
# (Через UI или API)
```

**Что проверять:**
- Корректное соединение между Flowise и Qdrant
- Правильное создание и использование коллекций
- Эффективность векторного поиска в реальном времени
- Управление векторными данными через Flowise

### 4.3.10. Тестирование функций хранения и памяти

```bash
# Проверка настроек памяти в Flowise
docker exec flowise env | grep MEMORY

# Тестирование API для взаимодействия с памятью
FLOW_ID=$(curl -k -s https://flowise.yourdomain.com/api/v1/chatflows | jq -r '.[0].id')

# Отправка нескольких последовательных запросов в одной сессии
SESSION_ID="memory-test-$(date +%s)"

# Первый запрос
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d "{
    \"question\": \"Меня зовут Тестер. Запомни это, пожалуйста.\",
    \"overrideConfig\": {
      \"sessionId\": \"${SESSION_ID}\"
    }
  }"

# Второй запрос (должен помнить контекст)
sleep 5
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d "{
    \"question\": \"Как меня зовут?\",
    \"overrideConfig\": {
      \"sessionId\": \"${SESSION_ID}\"
    }
  }"
```

**Что проверять:**
- Сохранение контекста между запросами в одной сессии
- Правильное разделение сессий между разными пользователями
- Ограничение длины истории (если настроено)
- Сохранение памяти при перезапусках (если настроена персистентность)

### 4.3.11. Тестирование безопасности Flowise

#### 4.3.11.1. Проверка настроек аутентификации

```bash
# Проверка настроек аутентификации
docker exec flowise env | grep AUTH

# Тестирование доступа без аутентификации (должен вернуть ошибку, если настроена защита)
curl -k -I https://flowise.yourdomain.com/api/v1/chatflows

# Тестирование с неверными учетными данными
curl -k -X POST https://flowise.yourdomain.com/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username":"wrong","password":"wrong"}'
```

**Что проверять:**
- Правильная настройка аутентификации
- Отказ в доступе при отсутствии или неверных учетных данных
- Защита важных API-эндпоинтов
- Безопасность токенов и сессий

#### 4.3.11.2. Проверка обработки конфиденциальных данных

```bash
# Проверка хранения API-ключей и других конфиденциальных данных
docker exec flowise ls -la /root/.flowise

# Тестирование обработки API-ключей
curl -k -X POST "https://flowise.yourdomain.com/api/v1/prediction/${FLOW_ID}" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Тестирование безопасности",
    "overrideConfig": {
      "apiKey": "fake-api-key-for-testing"
    }
  }'
```

**Что проверять:**
- Безопасное хранение ключей API и учетных данных
- Отсутствие утечки конфиденциальной информации в логах
- Правильное шифрование чувствительных данных
- Соблюдение принципа минимальных привилегий

### 4.3.12. Тестирование кастомизации и расширяемости

```bash
# Проверка кастомных настроек
docker exec flowise env | grep FLOWISE

# Тестирование использования переменных окружения
docker exec flowise env | grep -E 'OPENAI_API_KEY|ANTHROPIC_API_KEY|COHERE_API_KEY'
```

**Что проверять:**
- Правильное применение настроек из переменных окружения
- Возможность использования кастомных моделей
- Расширяемость с помощью пользовательских компонентов
- Гибкость в настройке интерфейса и поведения
